<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kakao Login Callback</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; padding: 40px; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-bottom: 16px; }
        h3 { font-size: 14px; color: #333; margin-bottom: 8px; }
        .result { background: #f8f9fa; border-radius: 8px; padding: 16px; margin: 16px 0; }
        pre { background: #e9ecef; padding: 12px; border-radius: 6px; font-size: 11px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }
        .btn { display: block; width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 12px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { opacity: 0.9; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .loading { text-align: center; padding: 40px; }
        .step { padding: 16px; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 16px; }
        .step-title { font-weight: 600; margin-bottom: 8px; }
        .step-desc { font-size: 12px; color: #666; margin-bottom: 12px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h2>카카오 로그인 테스트</h2>
            <div id="loading" class="loading">토큰 발급 중...</div>

            <!-- Step 1: Kakao Token -->
            <div id="step1" class="step hidden">
                <div class="step-title">Step 1: 카카오 Access Token 발급 완료</div>
                <div class="step-desc">이 토큰은 카카오에서 발급한 토큰입니다. 모바일 SDK에서도 이와 같은 토큰을 받게 됩니다.</div>
                <h3>Kakao Access Token</h3>
                <pre id="kakao-token"></pre>
            </div>

            <!-- Step 2: Backend API Test -->
            <div id="step2" class="step hidden">
                <div class="step-title">Step 2: 백엔드 /api/v1/auth/login API 테스트</div>
                <div class="step-desc">위 카카오 토큰으로 우리 백엔드 API를 호출합니다.</div>
                <button class="btn btn-primary" onclick="testBackendLogin()">백엔드 로그인 API 호출</button>
                <div id="backend-result" class="result hidden">
                    <h3>API 응답</h3>
                    <pre id="backend-response"></pre>
                </div>
            </div>

            <div id="error" class="error" style="display:none;"></div>
            <button class="btn btn-secondary" onclick="location.href='/test/login'">돌아가기</button>
        </div>
    </div>

    <script th:inline="javascript">
        const kakaoClientId = [[${kakaoClientId}]];
        const code = new URLSearchParams(window.location.search).get('code');
        let kakaoAccessToken = null;

        if (code) {
            // Step 1: 카카오 토큰만 받아오기 (테스트용 API)
            fetch('/test/api/kakao/token?code=' + code)
                .then(async res => {
                    document.getElementById('loading').style.display = 'none';

                    if (!res.ok) {
                        const text = await res.text();
                        document.getElementById('error').style.display = 'block';
                        document.getElementById('error').textContent = '카카오 토큰 발급 실패 (' + res.status + '): ' + text;
                        return;
                    }

                    const data = await res.json();
                    kakaoAccessToken = data.accessToken || data.access_token;

                    document.getElementById('step1').classList.remove('hidden');
                    document.getElementById('step2').classList.remove('hidden');
                    document.getElementById('kakao-token').textContent = kakaoAccessToken;
                })
                .catch(err => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').textContent = '오류: ' + err.message;
                });
        } else {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = '인가 코드가 없습니다.';
        }

        // Step 2: 백엔드 로그인 API 테스트
        async function testBackendLogin() {
            if (!kakaoAccessToken) {
                alert('카카오 토큰이 없습니다.');
                return;
            }

            try {
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        socialType: 'KAKAO',
                        accessToken: kakaoAccessToken
                    })
                });

                const data = await response.json();
                const resultEl = document.getElementById('backend-response');
                resultEl.textContent = JSON.stringify(data, null, 2);
                resultEl.className = response.ok ? 'success' : 'error';
                document.getElementById('backend-result').classList.remove('hidden');
            } catch (error) {
                document.getElementById('backend-response').textContent = 'Error: ' + error.message;
                document.getElementById('backend-response').className = 'error';
                document.getElementById('backend-result').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
